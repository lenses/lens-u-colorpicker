<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../lenses-styles/theme-styles.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <lens-u-colorpicker></lens-u-colorpicker>

@demo
-->
<dom-module id="lens-u-colorpicker">
  <template>
    <style include="theme-styles"></style>
    <style>
      :host {
        display: block;
        font-family: sans-serif;
        box-sizing: border-box;
        /*width: 300px;*/
        /*height: 300px;*/
        width: 100%;
        height: 100%;
        display: inline-block;
      }

      #color {
        display: inline-block;
        height: 26px;
        width: 100%;
        padding: 3px;
        box-sizing: border-box;
        background-color: var(--selected-color);
        color: var(--contrast-color);
      }

      iron-icon {
        cursor: pointer;
        background-color: color: var(--contrast-color);
        float: right;
      }

      .swatch-container {
        min-height: 26px;
        padding: 3px 5px;
        box-sizing: border-box;
        background-color: var(--background);
      }

      .swatch {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        margin-top: 2px;
        
      }

      #colorpicker {
        background-color: white;
        width: 100%;
      }

      /* Note: It seems that /deep/ combinator is required to select classes within the #colorpicker div */
      #colorpicker /deep/ .picker-wrapper, #colorpicker /deep/ .slide-wrapper {
        display: inline-block;
        float: left;
        box-sizing: border-box;
        cursor: pointer;
      }

      #colorpicker /deep/ .picker-wrapper {
        width: 85%;
      }

      #colorpicker /deep/ .slide-wrapper {
        width: 15%;
        border-left: 2px solid white;
      }

      #colorpicker /deep/ .picker, #colorpicker /deep/ .slide {
        width: 100%;
        height: 200px;
      }

     /* TODO: These indicators do not move with the chosen color for some reason. Disabled temporarily */
     /* #colorpicker /deep/ .picker-indicator {
        width: 5px;
        height: 5px;
        border: 2px solid white 1px solid black;
      }

      #colorpicker /deep/ .slide-indicator {
        width: 100%;
        height: 5px;
        left: 0px;
        background-color: black;
      }
  */
    </style>
    <div id="color"><span>{{color}}</span> <iron-icon icon="arrow-drop-down" on-click="toggleCollapse"></iron-icon></div>
    <iron-collapse id="collapse" opened="true">
    <div class="swatch-container">
      <template is="dom-if" if="{{!presetColors.length}}">
        <span class="bg-accent0 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent1 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent2 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent3 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent4 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent5 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent6 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent7 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent8 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent9 swatch" on-click="_chooseColor"></span>
        <span class="bg-accent10 swatch" on-click="_chooseColor"></span>
      </template>
      <template is="dom-if" if="{{presetColors.length}}">
        <template is="dom-repeat" items="{{presetColors}}" as="color">
          <span class="swatch" style$="{{_applyColor(color)}}" on-click="_chooseColor"></span>
        </template>
      </template>
    </div>
    <div id="colorpicker"></div>
    </iron-collapse>
  </template>

</dom-module>
<script type="text/javascript" src="../flexi-color-picker/colorpicker.js"></script>
<script>

  Polymer({

    is: 'lens-u-colorpicker',

    properties: {

      /**
       * `fancy` indicates that the element should don a monocle and tophat,
       * while checking its pocket watch.
       */
      color:  {
        type: String,
        value: '#FFFFFF',
        // observer: 'colorChanged'
      },
      presetColors: {
        value: function(){
          return [];
        },
        type: Array
      }
    },
    listeners: {
      'colorpicker.tap': '_changeColor',
      'colorpicker.track': '_changeColor'
    },

    ready: function() {
      this.customStyle['--selected-color'] = this.color;
      
      var colorPicker = ColorPicker(this.$.colorpicker, function(hex, hsv, rgb) {
          this.color = hex.toUpperCase();
      }.bind(this));

      this.updateStyles();
    },

    // Element Behavior

    /**
     * The `lens-u-colorpicker-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event lens-u-colorpicker-lasers
     * @detail {{sound: String}}
     */

    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'lens-u-colorpicker says, ' + response;
    },

    /**
     * Attempts to destroy this element's enemies with an any beam of light!
     *
     * Or, at least, dispatches an event in the vain hope that someone else will
     * do the zapping.
     */
    fireLasers: function() {
      this.fire('lens-u-colorpicker-lasers', {sound: 'Pew pew!'});
    },
    accentClass: function(index){
      return 'accent'+index;
    },
    toggleCollapse: function(){
      this.$.collapse.toggle();
    },
    _applyColor: function(color){
      console.log(color);
      console.log("background-color: " + color)
      return "background-color: " + color + ";";
    },

    _changeColor: function(){
      
      this.customStyle['--selected-color'] = this.color;
      this.customStyle['--contrast-color'] = this._contrastColor(this.color);
      
      // Updates the color reflected in stylesheet. Why doesn't this.updateStyles() work, like suggested in the docs?
      Polymer.updateStyles();
    },
    _contrastColor: function(colorToContrast){
      // Note: Hexcodes where the first character is a number less than 5 tend to be dark colors, so white would be the contrast color.
      
      var hexMatch = colorToContrast.match(/#(\d)/); // Creates a match group for the first character in hex code if it is a digit.
      var contrastColor = '#000000'; // Sets default contrast color to black.
      if (hexMatch){
        if (parseInt(hexMatch[1]) < 5 ){
          contrastColor = '#FFFFFF'; // The selected color is dark, so set contrast color to be white.
        }
      } 
      return contrastColor;
    },
    _chooseColor: function(e, detail){
      var swatchEl = e.path[0];
      var rgb = window.getComputedStyle(swatchEl).backgroundColor;

      var hex = this._rgbToHex(rgb);
      if (hex){
        this.color = hex;
        this._changeColor();
      }
    },
    _rgbToHex: function(rgb){
      var hexChars = '0123456789ABCDEF';
      var rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);

      function hex(x) {
        return isNaN(x) ? "00" : hexChars[(x - x % 16) / 16] + hexChars[x % 16];
      }

      if (rgb){
        var r = hex(rgb[1]);
        var g = hex(rgb[2])
        var b =  hex(rgb[3]);
        var hex = '#' + r + g + b;
        return hex;
      } else {
        return;
      }
      
    }

  });

</script>
