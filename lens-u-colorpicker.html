<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../lenses-styles/theme-styles.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <lens-u-colorpicker></lens-u-colorpicker>

@demo
-->
<dom-module id="lens-u-colorpicker">
  <style include="theme-styles"></style>
  <style>
    :host {
      display: block;
      font-family: sans-serif;
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      background-color: var(--background);
    }

    #color {
      height: 26px;
      width: 100%;
      padding: 3px;
      box-sizing: border-box;
      background-color: var(--selected-color);
      color: var(--contrast-color);
    }

    .swatch {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
      margin-top: 2px;
      
    }

    .swatch-container {
      min-height: 26px;
      padding: 3px 5px;
      box-sizing: border-box;
    }

    iron-icon {
      cursor: pointer;
    }
  </style>

  <template>
    <div id="color"><span>{{color}}</span> <iron-icon icon="arrow-drop-down"></iron-icon></div>
    <div class="swatch-container">
      <span class="bg-accent0 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent1 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent2 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent3 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent4 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent5 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent6 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent7 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent8 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent9 swatch" on-click="_chooseColor"></span>
      <span class="bg-accent10 swatch" on-click="_chooseColor"></span>
    </div>
    <div id="picker" class="cp-small"></div>
  </template>

</dom-module>
<script type="text/javascript" src="../flexi-color-picker/colorpicker.js"></script>
<script>

  Polymer({

    is: 'lens-u-colorpicker',

    properties: {

      /**
       * `fancy` indicates that the element should don a monocle and tophat,
       * while checking its pocket watch.
       */
      color:  {
        type: String,
        value: '#FFFFFF',
        // observer: 'colorChanged'
      },
    },
    listeners: {
      'picker.tap': '_changeColor',
      'picker.track': '_changeColor'
    },

    // Element Lifecycle
    _changeColor: function(){
      
      this.customStyle['--selected-color'] = this.color;
      this.customStyle['--contrast-color'] = this._contrastColor(this.color);
      
      // Updates the color reflected in stylesheet. Why doesn't this.updateStyles() work, like suggested in the docs?
      Polymer.updateStyles();
    },
    _contrastColor: function(colorToContrast){
      // Note: Hexcodes where the first character is a number less than 5 tend to be dark colors, so white would be the contrast color.
      
      var hexMatch = colorToContrast.match(/#(\d)/); // Creates a match group for the first character in hex code if it is a digit.
      var contrastColor = '#000000'; // Sets default contrast color to black.
      if (hexMatch){
        if (parseInt(hexMatch[1]) < 5 ){
          contrastColor = '#FFFFFF'; // The selected color is dark, so set contrast color to be white.
        }
      } 
      return contrastColor;
    },
    ready: function() {
      this.customStyle['--selected-color'] = this.color;
      
      var colorPicker = ColorPicker(this.$.picker, function(hex, hsv, rgb) {
          this.color = hex;
        }.bind(this));

      this.updateStyles();
    },

    attached: function() {

      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * The `lens-u-colorpicker-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event lens-u-colorpicker-lasers
     * @detail {{sound: String}}
     */

    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'lens-u-colorpicker says, ' + response;
    },

    /**
     * Attempts to destroy this element's enemies with an any beam of light!
     *
     * Or, at least, dispatches an event in the vain hope that someone else will
     * do the zapping.
     */
    fireLasers: function() {
      this.fire('lens-u-colorpicker-lasers', {sound: 'Pew pew!'});
    },
    accentClass: function(index){
      return 'accent'+index;
    },
    _chooseColor: function(e, detail){
      var swatchEl = e.path[0];
      var rgb = window.getComputedStyle(swatchEl).backgroundColor;

      var hex = this._rgbToHex(rgb);
      if (hex){
        this.color = hex;
        this._changeColor();
      }
    },
    _rgbToHex: function(rgb){
      var hexChars = '0123456789ABCDEF';
      var rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);

      function hex(x) {
        return isNaN(x) ? "00" : hexChars[(x - x % 16) / 16] + hexChars[x % 16];
      }

      if (rgb){
        var r = hex(rgb[1]);
        var g = hex(rgb[2])
        var b =  hex(rgb[3]);
        var hex = '#' + r + g + b;
        return hex;
      } else {
        return;
      }
      
    }

  });

</script>
